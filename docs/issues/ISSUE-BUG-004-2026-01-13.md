# ISSUE: TweenChain TypeError on Enemy Movement Completion

## Metadata

- **Reporter**: Senior Developer (Claude)
- **Date Reported**: 2026-01-13
- **Last Updated**: 2026-01-13
- **Status**: Open
- **Priority**: High
- **Type**: Bug
- **Assignee**: [Junior Developer]
- **Labels**: bug, phaser, animation, runtime-error
- **Related Issue ID**: N/A

## 1. Issue Summary

### One-Sentence Summary

A TypeError occurs in Phaser's TweenChain when enemies complete their movement path, causing console errors and potentially unstable behavior.

### Impact Assessment

- **Users Affected**: 100% during gameplay
- **Severity**: Major - Runtime errors during normal gameplay
- **Business Impact**: Poor quality perception; potential for cascading failures

## 2. Issue Classification

### Type Details

**Bug**: `TypeError: Cannot read properties of null (reading 'onComplete')` occurs when enemy movement tween completes.

### Reproducibility

- **Can Reproduce**: Always
- **First Seen**: Current version (v0.1.0)
- **Frequency**: Every time an enemy completes path or is destroyed

## 3. Environment & Context

### Affected Components

- [x] **Game Engine**: Phaser.js v3.90.0
- [x] **System**: Enemy movement system, Tween management
- [ ] **Network**: N/A

### System Configuration

```json
{
  "phaser_version": "3.90.0",
  "browser": "Chrome/Firefox/Safari (all affected)",
  "rendering": "WebGL"
}
```

### Reproduction Steps

1. Start the game at `http://localhost:3000`
2. Press SPACE to start a wave
3. Wait for enemies to traverse the grid
4. Open browser DevTools console
5. Observe TypeError appearing repeatedly

### Expected Behavior

- Enemy movement completes without errors
- Tween cleanup happens gracefully
- No console errors during normal gameplay

### Actual Behavior

- TypeError thrown: `Cannot read properties of null (reading 'onComplete')`
- Error occurs in Phaser's TweenChain dispatch
- Multiple errors per enemy

## 4. Technical Details

### Error Messages

```
TypeError: Cannot read properties of null (reading 'onComplete')
    at TweenChain2.dispatchEvent (phaser.js:136599:49)
    at TweenChain2.onCompleteHandler (phaser.js:134861:26)
    at TweenChain2.nextState (phaser.js:136451:28)
    at TweenChain2.update (phaser.js:136543:32)
    at TweenManager2.step (phaser.js:133584:33)
```

### Code Context

```typescript
// src/entities/Enemy.ts:124-154
public moveAlongPath(path: Phaser.Math.Vector2[]): void {
  if (this.isStopped) {
    return;
  }

  if (this.moveTween) {
    this.moveTween.destroy();  // <-- Potential issue: destroying active tween
  }

  const tweenChain = this.scene.tweens.chain({
    targets: this,
    tweens: path.map((point, index) => ({
      x: point.x,
      y: point.y,
      duration: 1000 / this.enemyData.speed,
      ease: 'Linear',
      // ...
    })),
  });

  tweenChain.on('complete', () => {
    this.onReachEnd();  // <-- Enemy destroyed here, but tween still has reference
  });

  this.moveTween = tweenChain;
}
```

```typescript
// src/entities/Enemy.ts:279-292
public destroy(): void {
  if (this.moveTween) {
    this.moveTween.destroy();  // <-- May be called while tween is processing
  }
  // ...
  super.destroy();
}
```

### Files to Examine

1. `src/entities/Enemy.ts:124-154` - moveAlongPath method
2. `src/entities/Enemy.ts:279-292` - destroy method
3. Phaser TweenChain lifecycle management

## 5. Root Cause Analysis

### Hypothesis

The error occurs due to a race condition:

1. TweenChain completes and triggers 'complete' event
2. `onReachEnd()` is called, which calls `destroy()`
3. `destroy()` tries to destroy the tween
4. Tween is already in middle of dispatching complete event
5. Internal callback reference becomes null, causing TypeError

### Investigation Notes

- **Test 1**: Error occurs consistently when enemies reach end
- **Test 2**: Error also occurs when enemies are killed (destroy called)
- **Test 3**: Multiple errors suggest it happens for each enemy

## 6. Solution Strategy

### Recommended Solution

Properly handle tween cleanup to avoid destroying during event dispatch.

### Implementation Approach

```typescript
// src/entities/Enemy.ts - Modified destroy method
public destroy(): void {
  // Remove 'complete' listener before destroying tween
  if (this.moveTween) {
    this.moveTween.off('complete');  // Remove listener first

    // Only destroy if tween is still valid and not already complete
    if (!this.moveTween.isDestroyed()) {
      this.moveTween.stop();  // Stop instead of destroy during dispatch
    }
    this.moveTween = undefined;  // Clear reference
  }

  if (this.healthBar) {
    this.healthBar.destroy();
  }

  if (this.sprite) {
    this.sprite.destroy();
  }

  super.destroy();
}

// Alternative: Use scene.time.delayedCall for safe destruction
public onReachEnd(): void {
  emitEvent('enemyReachedEnd', {
    enemy: this.getData(),
    damage: 1,
  });

  // Delay destruction to allow tween to complete dispatch
  this.scene.time.delayedCall(0, () => {
    this.destroy();
  });
}
```

## 7. Implementation Plan

### Development Tasks

- [ ] **Task 1**: Modify `destroy()` to safely handle tween cleanup
- [ ] **Task 2**: Remove event listeners before destroying tween
- [ ] **Task 3**: Use `stop()` instead of `destroy()` when appropriate
- [ ] **Task 4**: Consider using `delayedCall` for deferred destruction
- [ ] **Task 5**: Test with multiple enemies to ensure no errors

### Testing Requirements

- [ ] **Manual Testing**:
  - Start wave, let enemies traverse → No console errors
  - Kill enemies with towers → No console errors
  - Let enemies reach end → No console errors
- [ ] **Console Monitoring**: Zero TypeError messages during gameplay

### Dependencies

- None - can be fixed independently

## 8. Verification & Acceptance

### Definition of Done

- [ ] No TypeError in console during normal gameplay
- [ ] Enemies properly destroyed when reaching end
- [ ] Enemies properly destroyed when killed
- [ ] No memory leaks from orphaned tweens
- [ ] All existing tests pass

### Test Scenarios

1. Start 5 waves, let all enemies complete path → Zero errors
2. Place towers, kill all enemies → Zero errors
3. Mix of enemies killed and reaching end → Zero errors

## 9. Related Documents

- [Enemy.ts](../../src/entities/Enemy.ts)
- [Phaser TweenChain Docs](https://photonstorm.github.io/phaser3-docs/Phaser.Tweens.TweenChain.html)

## 10. Revision History

| Version | Date       | Author     | Changes        |
| ------- | ---------- | ---------- | -------------- |
| v1.0    | 2026-01-13 | Senior Dev | Issue reported |
