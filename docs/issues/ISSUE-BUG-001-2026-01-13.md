# ISSUE: Enemy Reach End Does Not Decrease Lives

## Metadata

- **Reporter**: Senior Developer (Claude)
- **Date Reported**: 2026-01-13
- **Last Updated**: 2026-01-13
- **Status**: Ready for Implementation
- **Priority**: Critical
- **Type**: Bug
- **Assignee**: [Junior Developer]
- **Labels**: bug, game-logic, event-system, critical, ready-to-implement
- **Related Issue ID**: N/A
- **Estimated Time**: 2-3 hours (implementation + testing)

## 1. Issue Summary

### One-Sentence Summary

When enemies reach the left edge of the game grid, the player's lives do not decrease, making the game unwinnable.

### Impact Assessment

- **Users Affected**: 100% of players
- **Severity**: Blocking - Core game mechanic broken
- **Business Impact**: Game is fundamentally broken; no lose condition exists

## 2. Issue Classification

### Type Details

**Bug**: Enemies reaching the end should decrease lives by 1, but lives remain unchanged.

### Reproducibility

- **Can Reproduce**: Always
- **First Seen**: Current version (v0.1.0)
- **Frequency**: Every time an enemy reaches the left edge

## 3. Environment & Context

### Affected Components

- [x] **Game Engine**: Phaser.js
- [x] **System**: Event handling between Enemy entity and game state
- [x] **Bridge**: React-Phaser communication via EventBus
- [ ] **Network**: N/A

### Current Event Handler Inventory

**File**: `src/components/PhaserGame.tsx` (lines 68-156)

Currently subscribed events:

```typescript
✓ sceneReady           (line 133)  // Scene initialization
✓ towerPlaced          (line 134)  // Tower placement tracking
✓ goldChanged          (line 135)  // Gold state updates
✓ livesChanged         (line 136)  // Lives state updates (reacts to livesChanged)
✓ gamePaused           (line 137)  // Pause state
✓ gameResumed          (line 138)  // Resume state
✓ gameOver             (line 139)  // Game over handling
✓ waveStarted          (line 140)  // Wave progression
✓ waveCompleted        (line 141)  // Wave completion
✓ enemyKilled          (line 142)  // Enemy kill tracking
✗ enemyReachedEnd      [MISSING]   // Should trigger lives decrement
```

### Reproduction Steps

1. Start the game at `http://localhost:3000`
2. Press SPACE key to start Wave 1
3. Wait for enemies to traverse the grid from right to left
4. Observe that Lives counter remains at 3 when enemies exit left

### Expected Behavior

When an enemy reaches the left edge:

1. `enemyReachedEnd` event should be caught by handler in `PhaserGame.tsx`
2. Handler should decrement lives by `data.damage` (currently always 1)
3. Handler should emit `livesChanged` event with new lives count
4. If lives reach 0, handler should emit `gameOver` event with `won: false`
5. Game over screen should appear showing "Game Over" and final score

### Actual Behavior

- `enemyReachedEnd` event is emitted by `Enemy.ts:217` ✅
- **No handler subscribes to this event** ❌
- Lives remain at initial value (3) ❌
- `livesChanged` event is never emitted ❌
- Game never ends ❌

### Additional Observations

- Initial lives: 3 (from `gameStore.ts:89`)
- Damage per enemy: 1 (hardcoded in `Enemy.ts:217`)
- Multiple enemies can reach end simultaneously → lives should decrement for each
- No integration tests for enemy reaching end scenario

## 4. Technical Details

### Error Messages

No error messages - silent failure

### Code Context

```typescript
// src/entities/Enemy.ts:209-223
public onReachEnd(): void {
  // Emit to scene event system for EnemySystem tracking
  this.scene.events.emit('enemyReachedEnd', {
    enemy: this.getData(),
    damage: 1,
  });

  // Emit to EventBus for UI updates and game state
  emitEvent('enemyReachedEnd', {
    enemy: this.getData(),
    damage: 1,
  });

  this.destroy();
}
```

**Problem**: The `enemyReachedEnd` event is emitted but never handled.

### Files to Examine

1. `src/entities/Enemy.ts:209-223` - Event emission (working)
2. `src/components/PhaserGame.tsx` - Missing event handler
3. `src/scenes/GameScene.ts` - Missing event handler

## 5. Root Cause Analysis

### Hypothesis

The `enemyReachedEnd` event is emitted but no subscriber handles it to:

1. Emit `livesChanged` event with decremented lives
2. Check for game over condition (lives <= 0)

### Investigation Notes

- **Test 1**: Checked `src/components/PhaserGame.tsx` → No subscription to `enemyReachedEnd` ❌
- **Test 2**: Checked `src/scenes/GameScene.ts` → No subscription to `enemyReachedEnd` ❌
- **Test 3**: Searched entire codebase for `enemyReachedEnd` subscriptions → Found 0 handlers ❌
- **Test 4**: Verified event emission in `src/entities/Enemy.ts:217` → Working correctly ✅
- **Confirmed**: Event is emitted but never consumed anywhere in the codebase

### Root Cause

**Missing event handler for `enemyReachedEnd` in `PhaserGame.tsx`**

The enemy entity correctly emits the event when reaching the path end, but:

1. No React component subscribes to this event
2. No lives decrement logic exists
3. No game over check exists for lives reaching 0
4. The game has no lose condition, making it fundamentally broken

## 6. Solution Strategy

### Recommended Solution

Add `enemyReachedEnd` event handler in `src/components/PhaserGame.tsx`.

**Rationale for PhaserGame.tsx location:**

- Consistent with all other event handlers (lines 70-130)
- Centralizes React-Phaser bridge logic
- Already has access to `useGameStore` and `emitEvent`
- Follows existing subscription/cleanup pattern
- GameScene.ts has no React hooks access for store updates

### Implementation Approach

#### Step 1: Add Handler Function

**Location**: `src/components/PhaserGame.tsx`, after line 130 (after `handleEnemyKilled`)

```typescript
// Enemy events
const handleEnemyKilled = (_data: GameEvents['enemyKilled']): void => {
  useGameStore.getState().incrementEnemiesKilled();
  // Gold reward is handled via goldChanged event from GameScene
};

const handleEnemyReachedEnd = (data: GameEvents['enemyReachedEnd']): void => {
  const state = useGameStore.getState();
  const newLives = state.lives - data.damage;

  // Update lives in store
  state.setLives(newLives);

  // Emit livesChanged event for UI updates
  emitEvent('livesChanged', { lives: newLives, change: -data.damage });

  // Check for game over condition
  if (newLives <= 0) {
    emitEvent('gameOver', { won: false, score: state.score });
  }
};
```

#### Step 2: Subscribe to Event

**Location**: `src/components/PhaserGame.tsx`, after line 142 (after `enemyKilled` subscription)

```typescript
// Subscribe to all events
subscribeToEvent('sceneReady', handleSceneReady);
subscribeToEvent('towerPlaced', handleTowerPlaced);
subscribeToEvent('goldChanged', handleGoldChanged);
subscribeToEvent('livesChanged', handleLivesChanged);
subscribeToEvent('gamePaused', handleGamePaused);
subscribeToEvent('gameResumed', handleGameResumed);
subscribeToEvent('gameOver', handleGameOver);
subscribeToEvent('waveStarted', handleWaveStarted);
subscribeToEvent('waveCompleted', handleWaveCompleted);
subscribeToEvent('enemyKilled', handleEnemyKilled);
subscribeToEvent('enemyReachedEnd', handleEnemyReachedEnd); // ← ADD THIS LINE
```

#### Step 3: Add Cleanup

**Location**: `src/components/PhaserGame.tsx`, after line 154 (after `enemyKilled` cleanup)

```typescript
return (): void => {
  unsubscribeFromEvent('sceneReady', handleSceneReady);
  unsubscribeFromEvent('towerPlaced', handleTowerPlaced);
  unsubscribeFromEvent('goldChanged', handleGoldChanged);
  unsubscribeFromEvent('livesChanged', handleLivesChanged);
  unsubscribeFromEvent('gamePaused', handleGamePaused);
  unsubscribeFromEvent('gameResumed', handleGameResumed);
  unsubscribeFromEvent('gameOver', handleGameOver);
  unsubscribeFromEvent('waveStarted', handleWaveStarted);
  unsubscribeFromEvent('waveCompleted', handleWaveCompleted);
  unsubscribeFromEvent('enemyKilled', handleEnemyKilled);
  unsubscribeFromEvent('enemyReachedEnd', handleEnemyReachedEnd); // ← ADD THIS LINE
};
```

### Code Dependencies

**Existing imports already present:**

- `useGameStore` from `'../store/gameStore'` (line 17)
- `emitEvent`, `subscribeToEvent`, `unsubscribeFromEvent`, `GameEvents` from `'../utils/EventBus'` (lines 10-16)
- `useEffect` from `'react'` (line 3)

**No new imports required** - all dependencies are already present.

## 7. Implementation Plan

### Development Tasks

- [ ] **Task 1**: Add `handleEnemyReachedEnd` function in `PhaserGame.tsx` (after `handleEnemyKilled`, line 130)
- [ ] **Task 2**: Subscribe to `enemyReachedEnd` event in `PhaserGame.tsx` (line 142)
- [ ] **Task 3**: Add cleanup for `enemyReachedEnd` subscription in `PhaserGame.tsx` (line 154)
- [ ] **Task 4**: Add console.log to handler for debugging (optional, can remove after verification)
- [ ] **Task 5**: Run `npm run type-check` to ensure no TypeScript errors
- [ ] **Task 6**: Manual testing - verify lives decrement when enemy reaches end
- [ ] **Task 7**: Manual testing - verify game over triggers when lives reach 0
- [ ] **Task 8**: Write unit tests for event handler logic
- [ ] **Task 9**: Write integration tests for complete event chain

### Testing Requirements

#### Unit Tests (New)

**File**: `src/components/PhaserGame.test.ts` (create if doesn't exist)

```typescript
describe('PhaserGame Event Handlers', () => {
  it('should decrement lives when enemyReachedEnd event is emitted', async () => {
    // Setup: Mock Phaser game, mount component
    // Action: Emit enemyReachedEnd event with damage: 1
    // Assert: Lives decreased from 3 to 2
  });

  it('should trigger game over when lives reach 0', async () => {
    // Setup: Mock game with 1 life remaining
    // Action: Emit enemyReachedEnd event with damage: 1
    // Assert: gameOver state set to true, won: false
  });

  it('should handle multiple enemies reaching end simultaneously', async () => {
    // Setup: Mock game with 3 lives
    // Action: Emit 3 enemyReachedEnd events rapidly
    // Assert: Lives = 0, game over triggered once
  });
});
```

#### Integration Tests (New)

**File**: `src/entities/Enemy.test.ts` (extend existing file)

```typescript
describe('Enemy Reach End Integration', () => {
  it('should emit enemyReachedEnd event when reaching path end', () => {
    // Mock EventBus.emitEvent
    // Create enemy, call onReachEnd()
    // Assert: enemyReachedEnd emitted with correct payload
  });

  it('should emit with damage: 1 by default', () => {
    // Assert: Event payload damage = 1
  });
});
```

#### Manual Testing

- [ ] **Test Case 1**: Start Wave 1, let 1 enemy reach end → Lives should decrease from 3 to 2
- [ ] **Test Case 2**: Let 3 enemies reach end → Lives should reach 0
- [ ] **Test Case 3**: Lives = 0 → Game Over screen should appear
- [ ] **Test Case 4**: Game Over screen shows "Game Over" (not "Victory")
- [ ] **Test Case 5**: Multiple enemies reach end in same frame → Lives = 0 correctly
- [ ] **Test Case 6**: Restart game after game over → Lives reset to 3

### Dependencies

- None (all required imports already present in PhaserGame.tsx)

## 8. Verification & Acceptance

### Definition of Done

- [ ] `enemyReachedEnd` event handler implemented in `PhaserGame.tsx`
- [ ] Handler correctly decrements lives by `data.damage` amount
- [ ] Handler emits `livesChanged` event with new lives value and change amount
- [ ] Lives decrease by 1 when enemy reaches end (current implementation: damage always = 1)
- [ ] Game over triggers when lives reach 0 or below
- [ ] Game over event includes `won: false` and final `score`
- [ ] Game over screen appears with "Game Over" message (not "Victory")
- [ ] All existing tests pass (`npm run test`)
- [ ] TypeScript type checking passes (`npm run type-check`)
- [ ] ESLint passes (`npm run lint`)
- [ ] Manual testing confirms all test scenarios pass
- [ ] Edge cases handled (multiple enemies reaching simultaneously)

### Test Scenarios

#### Basic Functionality

1. **Single Enemy**: Start Wave 1, let 1 enemy reach end → Lives decrease from 3 to 2
2. **Multiple Enemies**: Let all enemies in Wave 1 reach end → Lives decrease appropriately
3. **Game Over**: Let enemies reach end until Lives = 0 → Game Over screen appears

#### Edge Cases

4. **Simultaneous Enemies**: Multiple enemies reach end in same frame → Lives should correctly decrement for each (e.g., 3 enemies reach end when Lives = 3 → Lives = 0, Game Over triggered)
5. **Zero Lives**: Lives already at 0, enemy reaches end → Lives stay at 0, Game Over should not trigger again (idempotent)
6. **Negative Lives** (defensive): Enemy reaches end when Lives = 0 → Lives should become -1 (or handle gracefully)
7. **Rapid Fire**: Emit multiple `enemyReachedEnd` events rapidly → Lives should process all correctly
8. **Damage Variation** (future): If enemy damage varies (currently always 1), handler should use `data.damage` correctly

#### UI Verification

9. **Header Update**: Lives counter in UI updates in real-time as enemies reach end
10. **Game Over Screen**: Shows correct message ("Game Over"), not "Victory"
11. **Score Display**: Game Over screen shows final score from store
12. **Restart**: After game over, restarting should reset lives to 3

#### Event Chain Verification

13. **Event Order**: `enemyReachedEnd` → lives update → `livesChanged` → (if 0) `gameOver`
14. **Event Payloads**: Verify `livesChanged` has correct `{lives, change}` values
15. **GameOver Payload**: Verify `gameOver` has `{won: false, score}` with correct score

### Regression Testing

Run all existing tests to ensure no regressions:

```bash
npm run test
npm run type-check
npm run lint
```

## 9. Related Documents

- [GameScene.ts](../../src/scenes/GameScene.ts)
- [PhaserGame.tsx](../../src/components/PhaserGame.tsx)
- [Enemy.ts](../../src/entities/Enemy.ts)

## 10. Revision History

| Version | Date       | Author                  | Changes                                                                                                                                                    |
| ------- | ---------- | ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| v1.1    | 2026-01-13 | Sisyphus (AI Developer) | Enhanced issue with detailed implementation guide, test requirements, edge cases, and verification criteria. Updated status to "Ready for Implementation". |
| v1.0    | 2026-01-13 | Senior Dev              | Issue reported                                                                                                                                             |
