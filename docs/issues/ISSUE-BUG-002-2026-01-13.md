# ISSUE: Enemy Kill Does Not Award Gold Reward

## Metadata

- **Reporter**: Senior Developer (Claude)
- **Date Reported**: 2026-01-13
- **Last Updated**: 2026-01-13
- **Status**: Open
- **Priority**: Critical
- **Type**: Bug
- **Assignee**: [Junior Developer]
- **Labels**: bug, economy-system, event-system, critical
- **Related Issue ID**: N/A

## 1. Issue Summary

### One-Sentence Summary

When enemies are killed by towers, the player does not receive gold rewards, breaking the economy system.

### Impact Assessment

- **Users Affected**: 100% of players
- **Severity**: Blocking - Core economy mechanic broken
- **Business Impact**: Players cannot earn gold to build more towers; game progression impossible

## 2. Issue Classification

### Type Details

**Bug**: Killing enemies should award gold based on enemy type (Basic: 10g, Tank: 25g, etc.), but gold remains unchanged.

### Reproducibility

- **Can Reproduce**: Always
- **First Seen**: Current version (v0.1.0)
- **Frequency**: Every time an enemy is killed

## 3. Environment & Context

### Affected Components

- [x] **Game Engine**: Phaser.js
- [x] **System**: Economy/reward system, event handling
- [ ] **Network**: N/A

### Reproduction Steps

1. Start the game at `http://localhost:3000`
2. Place a Peashooter tower (costs 100g)
3. Press SPACE to start Wave 1
4. Observe tower killing enemies
5. Check Gold counter - remains at 50g (200 - 100 - 50 for Sunflower if placed)

### Expected Behavior

When an enemy is killed:

1. `enemyKilled` event fires with `reward` value
2. `goldChanged` event should fire with updated gold amount
3. Player's gold increases by enemy reward (Basic: 10g)

### Actual Behavior

- `enemyKilled` event fires correctly with reward data
- `goldChanged` event is NEVER emitted after kill
- Gold remains static
- Comment in code claims "Gold reward is handled via goldChanged event from GameScene" but this doesn't happen

## 4. Technical Details

### Code Context

```typescript
// src/components/PhaserGame.tsx:127-130
const handleEnemyKilled = (_data: GameEvents['enemyKilled']): void => {
  useGameStore.getState().incrementEnemiesKilled();
  // Gold reward is handled via goldChanged event from GameScene  <-- THIS IS FALSE
};
```

```typescript
// src/entities/Enemy.ts:179-191
public onDeath(): void {
  // Emit enemyKilled event with reward
  emitEvent('enemyKilled', {
    enemy: this.getData(),
    reward: this.enemyData.reward,  // reward is included but never used!
  });
  // ...
}
```

**Problem**: The comment claims GameScene handles gold rewards, but GameScene has no such handler.

### Files to Examine

1. `src/entities/Enemy.ts:179-191` - Event emission with reward data
2. `src/components/PhaserGame.tsx:127-130` - Handler ignores reward
3. `src/scenes/GameScene.ts` - No enemyKilled handler for gold

### Enemy Reward Values (from enemyConfigs.ts)

| Enemy Type | Reward |
| ---------- | ------ |
| Basic      | 10g    |
| Tank       | 25g    |
| Flying     | 20g    |
| Boss       | 100g   |
| Swarm      | 15g    |
| Armored    | 30g    |

## 5. Root Cause Analysis

### Hypothesis

The `handleEnemyKilled` function in PhaserGame.tsx receives the reward data but:

1. Only increments `enemiesKilled` counter
2. Does NOT emit `goldChanged` event
3. Does NOT add reward to player's gold

### Investigation Notes

- **Test 1**: Verified `enemyKilled` event includes reward data ✓
- **Test 2**: Verified `handleEnemyKilled` ignores reward data ✓
- **Test 3**: Searched for alternate gold reward handler - None exists

## 6. Solution Strategy

### Recommended Solution

Modify `handleEnemyKilled` in `PhaserGame.tsx` to add gold reward.

### Implementation Approach

```typescript
// In PhaserGame.tsx, modify handleEnemyKilled:
const handleEnemyKilled = (data: GameEvents['enemyKilled']): void => {
  const state = useGameStore.getState();

  // Increment kill counter
  state.incrementEnemiesKilled();

  // Add gold reward
  const newGold = state.gold + data.reward;
  state.setGold(newGold);

  // Emit goldChanged for UI updates
  emitEvent('goldChanged', { gold: newGold, change: data.reward });
};
```

## 7. Implementation Plan

### Development Tasks

- [ ] **Task 1**: Modify `handleEnemyKilled` to use `data.reward`
- [ ] **Task 2**: Add gold to player's state via `setGold`
- [ ] **Task 3**: Emit `goldChanged` event for UI sync
- [ ] **Task 4**: Update comment or remove misleading comment
- [ ] **Task 5**: Test with different enemy types

### Testing Requirements

- [ ] **Unit Tests**: Test gold reward calculation
- [ ] **Manual Testing**:
  - Kill Basic enemy → Gold +10
  - Kill Tank enemy → Gold +25
  - Kill Boss enemy → Gold +100
- [ ] **Integration Tests**: Verify gold updates in both Phaser and React UI

### Dependencies

- None (but should be fixed alongside ISSUE-BUG-001)

## 8. Verification & Acceptance

### Definition of Done

- [ ] Gold increases when enemies are killed
- [ ] Correct reward amount based on enemy type
- [ ] Gold counter in UI updates in real-time
- [ ] All existing tests pass

### Test Scenarios

1. Place Peashooter, start wave, kill Basic enemy → Gold should increase by 10
2. Kill multiple enemies → Gold should accumulate correctly
3. Kill Boss → Gold should increase by 100

## 9. Related Documents

- [Enemy.ts](../../src/entities/Enemy.ts)
- [PhaserGame.tsx](../../src/components/PhaserGame.tsx)
- [enemyConfigs.ts](../../src/entities/enemyConfigs.ts)

## 10. Revision History

| Version | Date       | Author     | Changes        |
| ------- | ---------- | ---------- | -------------- |
| v1.0    | 2026-01-13 | Senior Dev | Issue reported |
